<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test es-CO Survey Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #console-output { background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Test es-CO Survey Fix</h1>
    
    <div class="test-section info">
        <h3>Test Instructions</h3>
        <p>This page will help you test the es-CO survey fix. Follow these steps:</p>
        <ol>
            <li>Click "Open Main App" to open the dashboard in a new tab</li>
            <li>Sign in with the test credentials</li>
            <li>Switch to Spanish Colombia (es-CO) locale</li>
            <li>Navigate to the survey section</li>
            <li>Check for errors in the browser console</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>Quick Actions</h3>
        <button onclick="openMainApp()">Open Main App</button>
        <button onclick="testLocaleStorage()">Test Locale Storage</button>
        <button onclick="clearConsole()">Clear Console</button>
    </div>

    <div class="test-section">
        <h3>Test Credentials</h3>
        <p><strong>Email:</strong> quqa2y1jss@levante.com</p>
        <p><strong>Password:</strong> xbqamkqc7z</p>
        <button onclick="copyCredentials()">Copy Credentials</button>
    </div>

    <div class="test-section">
        <h3>Console Output</h3>
        <div id="console-output">Console messages will appear here...</div>
    </div>

    <script>
        // Capture console messages
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        function addToConsole(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            consoleOutput.textContent += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole('log', args.join(' '));
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole('warn', args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole('error', args.join(' '));
        };

        function openMainApp() {
            window.open('http://localhost:5173', '_blank');
            console.log('Opened main application in new tab');
        }

        function testLocaleStorage() {
            // Test setting the locale to es-CO
            sessionStorage.setItem('levantePlatformLocale', 'es-CO');
            console.log('Set locale to es-CO in sessionStorage');
            
            // Also test the old format
            sessionStorage.setItem('roarPlatformLocale', 'es-CO');
            console.log('Set locale to es-CO in sessionStorage (roar key)');
        }

        function copyCredentials() {
            const credentials = 'quqa2y1jss@levante.com / xbqamkqc7z';
            navigator.clipboard.writeText(credentials).then(() => {
                console.log('Credentials copied to clipboard');
            }).catch(() => {
                console.warn('Failed to copy credentials to clipboard');
            });
        }

        function clearConsole() {
            consoleOutput.textContent = '';
            console.log('Console cleared');
        }

        // Test the fix by simulating the problematic scenario
        function simulateRaceCondition() {
            console.log('Simulating race condition scenario...');
            
            // Simulate the conditions that were causing the error
            const mockSelectedAdmin = {
                value: null // This is what was causing the error
            };

            try {
                // This is similar to what was happening in the watch function
                if (!mockSelectedAdmin.value?.assessments) {
                    console.warn('selectedAdmin or assessments not available during survey initialization');
                    return;
                }
                
                const isAssessment = mockSelectedAdmin.value.assessments.some((task) => task.taskId === 'survey');
                console.log('Assessment check passed:', isAssessment);
            } catch (error) {
                console.error('Race condition error caught:', error.message);
            }
        }

        // Run initial tests
        console.log('Test page loaded successfully');
        console.log('Testing race condition handling...');
        simulateRaceCondition();

        // Listen for messages from the main app
        window.addEventListener('message', (event) => {
            if (event.origin === 'http://localhost:5173') {
                console.log('Message from main app:', event.data);
            }
        });
    </script>
</body>
</html>
