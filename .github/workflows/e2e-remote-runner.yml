name: E2E Remote Runner

on:
  workflow_dispatch:
    inputs:
      specId:
        description: Catalog spec id (allowlisted)
        required: true
        type: string
      baseUrl:
        description: Target baseUrl to run against
        required: true
        type: string
      clientRunId:
        description: Client run id (for correlation)
        required: true
        type: string

run-name: e2e ${{ inputs.clientRunId }} ${{ inputs.specId }}

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Resolve spec path
        id: spec
        shell: bash
        run: |
          set -euo pipefail
          SPEC_ID="${{ inputs.specId }}"
          case "$SPEC_ID" in
            gh-0737-open) SPEC="cypress/e2e/researchers/bugs/gh-0737-open.cy.ts" ;;
            gh-0733-open) SPEC="cypress/e2e/researchers/bugs/gh-0733-open.cy.ts" ;;
            gh-0735-open) SPEC="cypress/e2e/researchers/bugs/gh-0735-open.cy.ts" ;;
            gh-0766-open) SPEC="cypress/e2e/researchers/bugs/gh-0766-open.cy.ts" ;;
            gh-0719-closed) SPEC="cypress/e2e/researchers/bugs/gh-0719-closed.cy.ts" ;;
            task-add-group) SPEC="cypress/e2e/researchers/tasks/add-group.cy.ts" ;;
            task-administrator-login) SPEC="cypress/e2e/researchers/tasks/administrator-login.cy.ts" ;;
            task-assignment-task-conditions) SPEC="cypress/e2e/researchers/tasks/assignment-task-conditions.cy.ts" ;;
            task-monitor-completion) SPEC="cypress/e2e/researchers/tasks/monitor-completion.cy.ts" ;;
            task-researcher-full-workflow) SPEC="cypress/e2e/researchers/tasks/researcher-full-workflow.cy.ts" ;;
            task-researcher-docs-website) SPEC="cypress/e2e/researchers/tasks/researcher-docs-website.cy.ts" ;;
            task-researcher-docs-scenario) SPEC="cypress/e2e/researchers/tasks/researcher-docs-scenario.cy.ts" ;;
            task-researcher-docs-site-admin-school-class-add-users) SPEC="cypress/e2e/researchers/tasks/researcher-docs-site-admin-school-class-add-users.cy.ts" ;;
            *)
              echo "Unknown/blocked specId: $SPEC_ID"
              exit 2
              ;;
          esac
          echo "spec=$SPEC" >> "$GITHUB_OUTPUT"

      - name: Run Cypress
        id: cypress
        shell: bash
        env:
          E2E_APP_URL: ${{ inputs.baseUrl }}
          CYPRESS_E2E_RUN_OPEN_BUGS: "true"
          CYPRESS_E2E_SITE_NAME: "ai-tests"
          CYPRESS_E2E_AI_ADMIN_EMAIL: ${{ secrets.E2E_AI_ADMIN_EMAIL }}
          CYPRESS_E2E_AI_ADMIN_PASSWORD: ${{ secrets.E2E_AI_ADMIN_PASSWORD }}
          CYPRESS_E2E_AI_SITE_ADMIN_EMAIL: ${{ secrets.E2E_AI_SITE_ADMIN_EMAIL }}
          CYPRESS_E2E_AI_SITE_ADMIN_PASSWORD: ${{ secrets.E2E_AI_SITE_ADMIN_PASSWORD }}
        run: |
          set -euo pipefail
          SPEC="${{ steps.spec.outputs.spec }}"
          BASE_URL="${{ inputs.baseUrl }}"
          RUN_LOG="e2e-run.log"

          echo "Running spec: $SPEC"
          echo "Target baseUrl: $BASE_URL"

          set +e
          npx cypress run --browser chrome --e2e --spec "$SPEC" --config "baseUrl=$BASE_URL,video=true" 2>&1 | tee "$RUN_LOG"
          EXIT_CODE="${PIPESTATUS[0]}"
          set -e

          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Upload Cypress artifacts (GitHub)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-artifacts-${{ inputs.clientRunId }}
          path: |
            cypress/videos/**
            cypress/screenshots/**
            e2e-run.log
          if-no-files-found: warn

      - name: Auth to Google Cloud
        if: always()
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.LEVANTE_PERF_GCP_SA_KEY }}

      - name: Setup gcloud
        if: always()
        uses: google-github-actions/setup-gcloud@v2

      - name: Persist results to bucket
        if: always()
        shell: bash
        env:
          BUCKET: levante-performance-dev
          OBJECT: test-results/levante-dashboard-e2e-results.json
          SPEC_ID: ${{ inputs.specId }}
          CLIENT_RUN_ID: ${{ inputs.clientRunId }}
          BASE_URL: ${{ inputs.baseUrl }}
          EXIT_CODE: ${{ steps.cypress.outputs.exit_code }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail
          mkdir -p .tmp-remote

          gsutil cat "gs://$BUCKET/$OBJECT" > .tmp-remote/results.json 2>/dev/null || echo '{"meta":{},"byId":{}}' > .tmp-remote/results.json

          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');
          const BUCKET = process.env.BUCKET;
          const OBJECT = process.env.OBJECT;
          const SPEC_ID = process.env.SPEC_ID;
          const CLIENT_RUN_ID = process.env.CLIENT_RUN_ID;
          const BASE_URL = process.env.BASE_URL;
          const EXIT_CODE = Number(process.env.EXIT_CODE ?? 1);
          const RUN_URL = process.env.RUN_URL;

          const now = new Date().toISOString();
          const result = EXIT_CODE === 0 ? 'pass' : 'fail';

          const raw = fs.readFileSync('.tmp-remote/results.json', 'utf8');
          let parsed;
          try { parsed = JSON.parse(raw); } catch { parsed = { meta: {}, byId: {} }; }
          if (!parsed || typeof parsed !== 'object') parsed = { meta: {}, byId: {} };
          if (!parsed.meta || typeof parsed.meta !== 'object') parsed.meta = {};
          if (!parsed.byId || typeof parsed.byId !== 'object') parsed.byId = {};

          let logTail = '';
          try {
            const log = fs.readFileSync('e2e-run.log', 'utf8');
            logTail = log.slice(Math.max(0, log.length - 12000));
          } catch {}

          const runPrefix = `gs://${BUCKET}/test-results/runs/${CLIENT_RUN_ID}`;
          parsed.byId[SPEC_ID] = {
            ...(parsed.byId[SPEC_ID] ?? {}),
            result,
            lastRunAt: now,
            lastRunRunId: CLIENT_RUN_ID,
            lastRunCommand: `npx cypress run --browser chrome --e2e --spec <resolved> --config baseUrl=${BASE_URL},video=true`,
            lastExitCode: EXIT_CODE,
            lastLogPath: `${runPrefix}/e2e-run.log`,
            lastLogTail: logTail,
            lastRunUrl: RUN_URL,
            targetBaseUrl: BASE_URL,
          };

          parsed.meta.updatedAt = now;
          parsed.meta.bucket = BUCKET;
          parsed.meta.objectPath = OBJECT;

          fs.writeFileSync('.tmp-remote/results.next.json', JSON.stringify(parsed, null, 2));
          NODE

          gsutil -m cp -n e2e-run.log "gs://$BUCKET/test-results/runs/$CLIENT_RUN_ID/e2e-run.log" || true
          gsutil -m cp -r cypress/videos "gs://$BUCKET/test-results/runs/$CLIENT_RUN_ID/" || true
          gsutil -m cp -r cypress/screenshots "gs://$BUCKET/test-results/runs/$CLIENT_RUN_ID/" || true

          gsutil cp .tmp-remote/results.next.json "gs://$BUCKET/$OBJECT"

